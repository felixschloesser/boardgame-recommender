openapi: 3.1.0

info:
  title: Boardgame Recommender API
  version: "0.2.0"
  description: |
    API for a boardgame recommender used in controlled user studies.
    Provides canonical boardgame metadata and preference-based
    recommendation generation with structured explainability.

servers:
  - url: /api/

tags:
  - name: auth
    description: Session initialization and termination.
  - name: games
    description: Canonical boardgame metadata used by the recommender.
  - name: recommendations
    description: Creation and retrieval of recommendation sessions.

components:

  securitySchemes:
    sessionCookie:
      type: apiKey
      in: cookie
      name: session_id

  schemas:

    ProblemDetails:
      type: object
      description: >
        Error payload following RFC 9457. Provides structured diagnostic information
        for validation failures, domain errors (e.g., unknown game), and authentication issues.
      properties:
        type: { type: string, format: uri }
        title: { type: string, minLength: 1 }
        status: { type: integer, minimum: 100, maximum: 599 }
        detail: { type: string }
        instance: { type: string, format: uri }
        code: { type: string }
        invalid_params:
          type: array
          items:
            type: object
            required: [name, reason]
            properties:
              name: { type: string }
              reason: { type: string }
              code: { type: string }
      unevaluatedProperties: false
      examples:
        - generic:
            summary: Generic RFC 9457 'about:blank' error
            value:
              type: "about:blank"
              title: "Internal Server Error"
              status: 500
              detail: "The server encountered an internal error while processing the request. Please try again later."
        - domain:
            summary: Domain error with specific type + code
            value:
              type: "https://example.com/errors/game-not-found"
              title: "Game not found"
              status: 404
              detail: "No boardgame exists with the specified ID."
              code: "GAME_NOT_FOUND"
        - validation:
            summary: Validation error illustrating structured field errors
            value:
              type: "https://example.com/errors/validation-error"
              title: "Validation failed"
              status: 400
              detail: "One or more input parameters were invalid."
              code: "VALIDATION_ERROR"
              invalid_params:
                - name: "play_context.players"
                  reason: "Value must be ≥ 1."
                  code: "RANGE_MIN"
                - name: "liked_games[0]"
                  reason: "Must match pattern '^[0-9]+$'."
                  code: "FORMAT_INVALID"
        - auth:
            summary: Authentication/authorization error
            value:
              type: "https://example.com/errors/unauthorized"
              title: "Authentication required"
              status: 401
              detail: "A valid session cookie is required to access this resource."
              code: "AUTH_INVALID_SESSION"

    Participant:
      type: object
      description: Representation of a study participant identified by a random ID.
      properties:
        participant_id: { type: string, minLength: 1 }
        study_group: { type: string }
      required: [participant_id, study_group]
      unevaluatedProperties: false

    Paginated:
      type: object
      description: Pagination envelope used for listing resources.
      properties:
        total: { type: integer, minimum: 0 }
        limit: { type: integer, minimum: 1, maximum: 100 }
        offset: { type: integer, minimum: 0 }
        items:
          type: array
          items: { type: object }
      required: [total, limit, offset]
      unevaluatedProperties: false

    BoardGame:
      type: object
      description: |
        Canonical boardgame metadata aligned with the model’s feature set.
      properties:
        id: { type: string, pattern: "^[0-9]+$" }
        title: { type: string, minLength: 1 }
        description: { type: string }
        mechanics:
          type: array
          items: { type: string, minLength: 1 }
          uniqueItems: true
          default: []
        genre:
          type: array
          items: { type: string, minLength: 1 }
          uniqueItems: true
          default: []
        themes:
          type: array
          items: { type: string, minLength: 1 }
          uniqueItems: true
          default: []
        min_players: { type: integer, minimum: 1 }
        max_players: { type: integer, minimum: 1 }
        complexity: { type: number, minimum: 0, maximum: 5 }
        age_recommendation: { type: integer, minimum: 0 }
        num_user_ratings: { type: integer, minimum: 0 }
        avg_user_rating: { type: number, minimum: 0, maximum: 10 }
        year_published: { type: integer, minimum: -3500, maximum: 2021 }
        playing_time_minutes: { type: integer, minimum: 1 }
        image_url: { type: string, format: uri }
        bgg_url: { type: string, format: uri }
      required:
        - id
        - title
        - description
        - mechanics
        - genre
        - themes
        - min_players
        - max_players
        - complexity
        - age_recommendation
        - num_user_ratings
        - year_published
        - playing_time_minutes
        - image_url
        - bgg_url
      unevaluatedProperties: false

    Recommendation:
      type: object
      description: |
        A recommendation entry paired with a structured explanation.
      properties:
        boardgame:
          $ref: "#/components/schemas/BoardGame"

        explanation:
          type: object
          description: Structured explanation of why this game was recommended.
          unevaluatedProperties: false
          required: [type]
          properties:
            type:
              type: string
              enum: ["references", "features"]

            references:
              type: array
              description: Reference-based reasoning using familiar games.
              minItems: 1
              maxItems: 3
              items:
                type: object
                unevaluatedProperties: false
                required: [bgg_id, title, influence]
                properties:
                  bgg_id:
                    type: integer
                    minimum: 1
                  title:
                    type: string
                    minLength: 1
                  influence:
                    type: string
                    enum: ["positive", "neutral", "negative"]

            features:
              type: array
              description: Feature-based reasoning exposing key domain factors used by the model.
              minItems: 1
              maxItems: 3
              items:
                type: object
                unevaluatedProperties: false
                required: [label, category, influence]
                properties:
                  label:
                    type: string
                  category:
                    type: string
                    enum:
                      - mechanic
                      - theme
                      - genre
                      - playtime
                      - complexity
                      - age
                  influence:
                    type: string
                    enum: ["positive", "neutral", "negative"]

              allOf:
                - if:
                    properties:
                      type: { const: "references" }
                  then:
                    required: ["type", "references"]
                - if:
                    properties:
                      type: { const: "features" }
                  then:
                    required: ["type", "features"]
      required: [boardgame, explanation]
      unevaluatedProperties: false

    RecommendationRequest:
      type: object
      description: |
        Preference profile supplied for generating recommendations.
      unevaluatedProperties: false
      properties:
        liked_games:
          type: array
          uniqueItems: true
          minItems: 1
          items: { type: integer, minimum: 1 }

        play_context:
          type: object
          unevaluatedProperties: false
          properties:
            players: { type: integer, minimum: 1 }
            duration:
              type: string
              enum: ["short", "medium", "long"]
          required: ["players"]

        num_results:
          type: integer
          minimum: 1
          maximum: 100
          default: 10
      required: [num_results, liked_games, play_context]



    RecommendationResponse:
      type: object
      description: |
        A complete recommendation session including input, model version,
        and produced ranked results.
      properties:
        session_id: { type: string, minLength: 1 }
        participant_id: { type: string, minLength: 1 }
        created_at: { type: string, format: date-time }
        intent:
          $ref: "#/components/schemas/RecommendationRequest"
        model_version: { type: string, minLength: 1 }
        experiment_group: { type: string }
        recommendations:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/Recommendation"
      required:
        - session_id
        - participant_id
        - created_at
        - intent
        - model_version
        - recommendations
      unevaluatedProperties: false

paths:

  /auth/session:
    post:
      tags: [auth]
      summary: Create a participant session.
      description: Creates a new session using a study token and issues a session cookie.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [study_token]
              properties:
                study_token: { type: string, minLength: 1 }
            examples:
              create_session:
                summary: Create session
                value:
                  study_token: "token-abc123"
      responses:
        "200":
          description: Session created.
          headers:
            Set-Cookie:
              schema: { type: string }
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Participant"
              examples:
                success:
                  summary: Session created
                  value:
                    participant_id: "p-48f2d0"
                    study_group: "control"
        "400":
          description: Invalid study token.
          content:
            application/problem+json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
              examples:
                invalid_token:
                  summary: Unknown or expired study token
                  value:
                    type: "https://example.com/errors/validation-error"
                    title: "Invalid study token"
                    status: 400
                    detail: "The provided study token is invalid or expired."
                    code: "INVALID_STUDY_TOKEN"

    delete:
      tags: [auth]
      summary: Terminate the current participant session.
      security:
        - sessionCookie: []
      responses:
        "204":
          description: Session deleted.
        "401":
          description: Unauthorized.
          content:
            application/problem+json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
              examples:
                unauthorized:
                  summary: Missing session cookie
                  value:
                    type: "https://example.com/errors/unauthorized"
                    title: "Authentication required"
                    status: 401
                    detail: "A valid session cookie is required to access this resource."
                    code: "AUTH_INVALID_SESSION"

  /recommendation:
    post:
      tags: [recommendations]
      summary: Generate recommendations for a participant.
      description: >
        Creates a recommendation session and returns the session payload along with a `Location`
        header pointing to `/recommendation/{session_id}`. Clients SHOULD navigate to or store
        that URL (e.g., update browser history) and use GET `/recommendation/{session_id}` to
        render or refresh the session view so reloads remain on the same recommendation.
        `Location` SHOULD be an absolute URL (e.g., `http://host/api/recommendation/{session_id}`). The `duration`
        field in `play_context` is optional; clients may omit it and send only `players`.
      security:
        - sessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/RecommendationRequest" }
            examples:
              recommend:
                summary: Generate recommendations
                value:
                  liked_games: [13, 9209, 30549]
                  play_context:
                    players: 4
                  num_results: 5
              recommend_with_duration:
                summary: Generate recommendations with duration
                value:
                  liked_games: [13, 9209, 30549]
                  play_context:
                    players: 4
                    duration: "medium"
                  num_results: 5
      responses:
        "201":
          description: Recommendation session created.
          headers:
            Location:
              description: URL of the created recommendation session resource.
              schema: { type: string, format: uri }
          content:
            application/json:
              schema: { $ref: "#/components/schemas/RecommendationResponse" }
              examples:
                created:
                  summary: Recommendations returned
                  value:
                    session_id: "sess-123"
                    participant_id: "p-48f2d0"
                    created_at: "2024-05-01T12:34:56Z"
                    model_version: "v1.3.2"
                    experiment_group: "A"
                    intent:
                      liked_games: [13, 9209, 30549]
                      play_context:
                        players: 4
                        duration: "medium"
                      num_results: 5
                    recommendations:
                      - boardgame:
                          id: "36218"
                          title: "Dominion"
                          description: "Pioneering deck-builder where each game uses a unique kingdom card set."
                          mechanics: ["Deck Building", "Hand Management"]
                          genre: ["Strategy", "Economic"]
                          themes: ["Medieval"]
                          min_players: 2
                          max_players: 4
                          complexity: 2.3
                          age_recommendation: 13
                          num_user_ratings: 120000
                          avg_user_rating: 7.5
                          year_published: 2008
                          playing_time_minutes: 30
                          image_url: "https://example.com/images/dominion.jpg"
                          bgg_url: "https://boardgamegeek.com/boardgame/36218/dominion"
                        explanation:
                          type: "features"
                          features:
                            - label: "Deck-building with tactical cycling"
                              category: "mechanic"
                              influence: "positive"
                            - label: "Plays in ~30 minutes"
                              category: "playtime"
                              influence: "positive"
                            - label: "Light economic engine"
                              category: "genre"
                              influence: "neutral"
        "400":
          description: Invalid request.
          content:
            application/problem+json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
              examples:
                bad_request:
                  summary: Invalid liked_games entry
                  value:
                    type: "https://example.com/errors/validation-error"
                    title: "Validation failed"
                    status: 400
                    detail: "One or more input parameters were invalid."
                    code: "VALIDATION_ERROR"
                    invalid_params:
                      - name: "liked_games[0]"
                        reason: "Must be an integer."
                        code: "TYPE_ERROR"
        "401":
          description: Unauthorized.
          content:
            application/problem+json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
              examples:
                unauthorized:
                  summary: Session missing
                  value:
                    type: "https://example.com/errors/unauthorized"
                    title: "Authentication required"
                    status: 401
                    detail: "A valid session cookie is required to access this resource."
                    code: "AUTH_INVALID_SESSION"
        "503":
          description: Recommender unavailable.
          content:
            application/problem+json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
              examples:
                unavailable:
                  summary: Backend busy
                  value:
                    type: "https://example.com/errors/service-unavailable"
                    title: "Recommender unavailable"
                    status: 503
                    detail: "Recommendation service is temporarily unavailable. Please retry."
                    code: "RECOMMENDER_UNAVAILABLE"

  /recommendation/{session_id}:
    get:
      tags: [recommendations]
      summary: Retrieve a stored recommendation session.
      security:
        - sessionCookie: []
      parameters:
        - in: path
          name: session_id
          required: true
          schema: { type: string, minLength: 1 }
      responses:
        "200":
          description: Recommendation session retrieved.
          content:
            application/json:
              schema: { $ref: "#/components/schemas/RecommendationResponse" }
              examples:
                feature_style_explanations:
                  summary: Previously created session (feature-style explanations)
                  value:
                    session_id: "sess-123"
                    participant_id: "p-48f2d0"
                    created_at: "2024-05-01T12:34:56Z"
                    model_version: "v1.3.2"
                    experiment_group: "A"
                    intent:
                      liked_games: [13, 9209, 30549]
                      play_context:
                        players: 4
                        duration: "medium"
                      num_results: 5
                    recommendations:
                    - boardgame:
                        id: "68448"
                        title: "7 Wonders"
                        description: "Draft cards over three ages to build your civilization."
                        mechanics: ["Card Drafting", "Set Collection"]
                        genre: ["Strategy", "Civilization"]
                        themes: ["Ancient"]
                        min_players: 2
                        max_players: 7
                        complexity: 2.3
                        age_recommendation: 10
                        num_user_ratings: 250000
                        avg_user_rating: 7.7
                        year_published: 2010
                        playing_time_minutes: 40
                        image_url: "https://example.com/images/7-wonders.jpg"
                        bgg_url: "https://boardgamegeek.com/boardgame/68448/7-wonders"
                      explanation:
                        type: "features"
                        features:
                          - label: "Fast card drafting"
                            category: "mechanic"
                          - label: "Plays up to 7 in ~40 minutes"
                            category: "playtime"
                          - label: "Light civilization tableau building"
                            category: "genre"
                reference_style_explanations:
                  summary: Previously created session (reference-style explanations)
                  value:
                    session_id: "sess-124"
                    participant_id: "p-48f2d0"
                    created_at: "2024-05-01T13:00:00Z"
                    model_version: "v1.3.2"
                    experiment_group: "A"
                    intent:
                      liked_games: [13, 9209, 30549]
                      play_context:
                        players: 4
                        duration: "medium"
                      num_results: 5
                    recommendations:
                      - boardgame:
                          id: "36218"
                          title: "Dominion"
                          description: "Pioneering deck-builder where each game uses a unique kingdom card set."
                          mechanics: ["Deck Building", "Hand Management"]
                          genre: ["Strategy", "Economic"]
                          themes: ["Medieval"]
                          min_players: 2
                          max_players: 4
                          complexity: 2.3
                          age_recommendation: 13
                          num_user_ratings: 120000
                          avg_user_rating: 7.5
                          year_published: 2008
                          playing_time_minutes: 30
                          image_url: "https://example.com/images/dominion.jpg"
                          bgg_url: "https://boardgamegeek.com/boardgame/36218/dominion"
                        explanation:
                          type: "references"
                          references:
                            - bgg_id: 13
                              title: "Catan"
                              influence: "positive"
                            - bgg_id: 9209
                              title: "Ticket to Ride"
                              influence: "positive"
                            - bgg_id: 30549
                              title: "Pandemic"
        "401":
          description: Unauthorized.
          content:
            application/problem+json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
              examples:
                unauthorized:
                  summary: Missing session cookie
                  value:
                    type: "https://example.com/errors/unauthorized"
                    title: "Authentication required"
                    status: 401
                    detail: "A valid session cookie is required to access this resource."
                    code: "AUTH_INVALID_SESSION"
        "404":
          description: Session not found.
          content:
            application/problem+json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
              examples:
                not_found:
                  summary: Unknown session
                  value:
                    type: "https://example.com/errors/session-not-found"
                    title: "Session not found"
                    status: 404
                    detail: "No recommendation session exists with the specified ID."
                    code: "SESSION_NOT_FOUND"

  /games:
    get:
      tags: [games]
      summary: List canonical boardgames.
      parameters:
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100, default: 10 }

        - in: query
          name: offset
          schema: { type: integer, minimum: 0, default: 0 }

        - in: query
          name: genre
          style: form
          explode: true
          schema:
            type: array
            items: { type: string, minLength: 1 }

        - in: query
          name: mechanics
          style: form
          explode: true
          schema:
            type: array
            items: { type: string, minLength: 1 }

        - in: query
          name: themes
          style: form
          explode: true
          schema:
            type: array
            items: { type: string, minLength: 1 }

        - in: query
          name: q
          schema: { type: string }
      responses:
        "200":
          description: Boardgames retrieved.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Paginated"
                  - type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: "#/components/schemas/BoardGame"
              examples:
                page:
                  summary: Paginated boardgames
                  value:
                    total: 2
                    limit: 10
                    offset: 0
                    items:
                      - id: "13"
                        title: "Catan"
                        description: "Trade, build, and settle on the island of Catan."
                        mechanics: ["Trading", "Dice Rolling"]
                        genre: ["Strategy", "Economic"]
                        themes: ["Medieval"]
                        min_players: 3
                        max_players: 4
                        complexity: 2.3
                        age_recommendation: 10
                        num_user_ratings: 150000
                        avg_user_rating: 7.2
                        year_published: 1995
                        playing_time_minutes: 75
                        image_url: "https://example.com/images/catan.jpg"
                        bgg_url: "https://boardgamegeek.com/boardgame/13/catan"
                      - id: "1406"
                        title: "Monopoly"
                        description: "Buy, trade, and build to bankrupt opponents."
                        mechanics: ["Roll and Move", "Player Elimination"]
                        genre: ["Family", "Economic"]
                        themes: ["Modern"]
                        min_players: 2
                        max_players: 8
                        complexity: 1.6
                        age_recommendation: 8
                        num_user_ratings: 120000
                        avg_user_rating: 4.4
                        year_published: 1935
                        playing_time_minutes: 120
                        image_url: "https://example.com/images/monopoly.jpg"
                        bgg_url: "https://boardgamegeek.com/boardgame/1406/monopoly"
        "400":
          description: Invalid pagination parameters.
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"
              examples:
                invalid_pagination:
                  summary: Invalid pagination
                  value:
                    type: "https://example.com/errors/validation-error"
                    title: "Validation failed"
                    status: 400
                    detail: "Limit must be between 1 and 100."
                    code: "RANGE_MAX"

  /games/{bgg_id}:
    get:
      tags: [games]
      summary: Retrieve metadata for a boardgame.
      parameters:
        - in: path
          name: bgg_id
          required: true
          schema: { type: integer, minimum: 1 }
      responses:
        "200":
          description: Boardgame retrieved.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BoardGame"
              examples:
                game:
                  summary: Single boardgame
                  value:
                    id: "13"
                    title: "Catan"
                    description: "Trade, build, and settle on the island of Catan."
                    mechanics: ["Trading", "Dice Rolling"]
                    genre: ["Strategy", "Economic"]
                    themes: ["Medieval"]
                    min_players: 3
                    max_players: 4
                    complexity: 2.3
                    age_recommendation: 10
                    num_user_ratings: 150000
                    avg_user_rating: 7.2
                    year_published: 1995
                    playing_time_minutes: 75
                    image_url: "https://example.com/images/catan.jpg"
                    bgg_url: "https://boardgamegeek.com/boardgame/13/catan"
        "404":
          description: Game not found.
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"
              examples:
                not_found:
                  summary: Unknown game
                  value:
                    type: "https://example.com/errors/game-not-found"
                    title: "Game not found"
                    status: 404
                    detail: "No boardgame exists with the specified ID."
                    code: "GAME_NOT_FOUND"
        "400":
          description: Invalid request.
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"
              examples:
                invalid_id:
                  summary: Invalid path parameter
                  value:
                    type: "https://example.com/errors/validation-error"
                    title: "Validation failed"
                    status: 400
                    detail: "Path parameter bgg_id must be a positive integer."
                    code: "FORMAT_INVALID"
