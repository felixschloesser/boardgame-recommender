openapi: 3.1.0

info:
  title: Boardgame Recommender API
  version: "0.1.0"
  description: |
    API for a boardgame recommender used in controlled user studies.
    Provides game metadata, preference-based recommendation generation,
    and complete audit trails for experimental conditions.

servers:
  - url: /api/

tags:
  - name: auth
    description: Authentication and session lifecycle.
  - name: games
    description: Access to the canonical boardgame dataset used by the recommender.
  - name: recommendations
    description: Creation and retrieval of recommendation sessions.

components:

  securitySchemes:
    sessionCookie:
      type: apiKey
      in: cookie
      name: session_id

  schemas:

    ProblemDetails:
      type: object
      description: >
        Error payload following RFC 9457. Provides structured diagnostic information
        for validation failures, domain errors (e.g., unknown game), and authentication issues.
      properties:
        type:
          type: string
          format: uri
          default: "about:blank"
        title:
          type: string
          minLength: 1
        status:
          type: integer
          minimum: 100
          maximum: 599
        detail:
          type: string
        instance:
          type: string
          format: uri
        code:
          type: string
        invalid_params:
          type: array
          items:
            type: object
            required: [name, reason]
            properties:
              name:
                type: string
              reason:
                type: string
              code:
                type: string
      required:
        - title
        - status
      unevaluatedProperties: false
      examples:
        generic:
          summary: Generic RFC 9457 'about:blank' error
          value:
            type: "about:blank"
            title: "Internal Server Error"
            status: 500
            detail: "An unexpected server-side condition was encountered. Please try again later."
        domain:
          summary: Domain error with specific type + code
          value:
            type: "https://example.com/errors/game-not-found"
            title: "Game not found"
            status: 404
            detail: "No boardgame exists with the specified ID."
            code: "GAME_NOT_FOUND"
        validation:
          summary: Validation error illustrating structured field errors
          value:
            type: "https://example.com/errors/validation-error"
            title: "Validation failed"
            status: 400
            detail: "One or more input parameters were invalid."
            code: "VALIDATION_ERROR"
            invalid_params:
              - name: "play_context.players"
                reason: "Value must be ≥ 1."
                code: "RANGE_MIN"
              - name: "liked_games[0]"
                reason: "Must match pattern '^[0-9]+$'."
                code: "FORMAT_INVALID"
        auth:
          summary: Authentication/authorization error
          value:
            type: "https://example.com/errors/unauthorized"
            title: "Authentication required"
            status: 401
            detail: "A valid session cookie is required to access this resource."
            code: "AUTH_INVALID_SESSION"

    Participant:
      type: object
      description: >
        A study participant represented by a random identifier. Tracks session creation
        and optional assignment to experiment groups without storing personal data.
      properties:
        participant_id:
          type: string
          minLength: 1
        created_at:
          type: string
          format: date-time
        study_group:
          type: string
      required:
        - participant_id
        - created_at
      unevaluatedProperties: false

    Paginated:
      type: object
      description: Generic pagination envelope used for listing boardgames or sessions.
      properties:
        total:
          type: integer
          minimum: 0
        limit:
          type: integer
          minimum: 1
          maximum: 100
        offset:
          type: integer
          minimum: 0
      required:
        - total
        - limit
        - offset
      unevaluatedProperties: false

    BoardGame:
      type: object
      description: >
        Canonical boardgame entry aligned with the recommender’s feature model.
        Includes player counts, mechanics, themes, complexity, and URLs for assets and metadata.
      properties:
        id:
          type: string
          pattern: "^[0-9]+$"
        title:
          type: string
          minLength: 1
        description:
          type: string
        mechanics:
          type: array
          items:
            type: string
            minLength: 1
          uniqueItems: true
          default: []
        genre:
          type: array
          items:
            type: string
            minLength: 1
          uniqueItems: true
          default: []
        themes:
          type: array
          items:
            type: string
            minLength: 1
          uniqueItems: true
          default: []
        min_players:
          type: integer
          minimum: 1
        max_players:
          type: integer
          minimum: 1
        complexity:
          type: number
          minimum: 0
          maximum: 5
        age_recommendation:
          type: integer
          minimum: 0
        num_user_ratings:
          type: integer
          minimum: 0
        avg_user_rating:
          type: number
          minimum: 0
          maximum: 10
        year_published:
          type: integer
          minimum: -3500
          maximum: 2021
        playing_time_minutes:
          type: integer
          minimum: 1
        image_url:
          type: string
          format: uri
        bgg_url:
          type: string
          format: uri
      required:
        - id
        - title
        - description
        - mechanics
        - genre
        - themes
        - min_players
        - max_players
        - complexity
        - age_recommendation
        - num_user_ratings
        - year_published
        - playing_time_minutes
        - image_url
        - bgg_url
      unevaluatedProperties: false

    RecommendationResult:
      type: object
      description: >
        A single ranked recommendation returned by the model, including score
        and position within the result list.
      properties:
        boardgame:
          $ref: "#/components/schemas/BoardGame"
        score:
          type: number
          description: Model score; higher is better.
        rank:
          type: integer
          minimum: 1
      required:
        - boardgame
        - score
        - rank
      unevaluatedProperties: false

    RecommendationRequest:
      type: object
      description: >
        User preference profile used to generate a recommendation session.
        Includes liked/disliked games, optional play context, and tag-level preferences.
      unevaluatedProperties: false
      properties:
        liked_games:
          type: array
          items:
            type: string
            pattern: "^[0-9]+$"
          uniqueItems: true
          default: []
        disliked_games:
          type: array
          items:
            type: string
            pattern: "^[0-9]+$"
          uniqueItems: true
          default: []
        play_context:
          type: ["object", "null"]
          unevaluatedProperties: false
          properties:
            players:
              type: ["integer", "null"]
              minimum: 1
            duration:
              type: ["string", "null"]
              enum: ["short", "medium", "long"]
        preference_tags:
          type: array
          items:
            type: string
            enum:
              - "strategy"
              - "cooperative"
              - "family-friendly"
              - "low-luck"
              - "thematic"
              - "party"
              - "economic"
              - "abstract"
          uniqueItems: true
          default: []
        avoid_tags:
          type: array
          items:
            type: string
            enum:
              - "strategy"
              - "cooperative"
              - "family-friendly"
              - "low-luck"
              - "thematic"
              - "party"
              - "economic"
              - "abstract"
          uniqueItems: true
          default: []
        num_results:
          type: integer
          minimum: 1
          maximum: 100
          default: 10
      required:
        - num_results

    Recommendation:
      type: object
      description: >
        Full recommendation session including participant metadata, model version,
        request intent, and ranked results. Enables reproducibility and experimental tracking.
      properties:
        session_id:
          type: string
          minLength: 1
        participant_id:
          type: string
          minLength: 1
        created_at:
          type: string
          format: date-time
        intent:
          $ref: "#/components/schemas/RecommendationRequest"
        model_version:
          type: string
          minLength: 1
        experiment_group:
          type: ["string", "null"]
        recommendations:
          type: array
          items:
            $ref: "#/components/schemas/RecommendationResult"
          minItems: 1
      required:
        - session_id
        - participant_id
        - created_at
        - intent
        - model_version
        - recommendations
      unevaluatedProperties: false

paths:

  /auth/session:
    post:
      tags: [auth]
      summary: Initialize a session
      description: >
        Creates a new participant session using a study token. Issues a session
        cookie used for authenticated access to recommendation endpoints.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              unevaluatedProperties: false
              properties:
                study_token:
                  type: string
                  minLength: 1
              required:
                - study_token
      responses:
        "200":
          description: Session created and session cookie issued.
          headers:
            Set-Cookie:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Participant"
        "400":
          description: Invalid study token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"
        "401":
          description: Unauthorized.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"

    delete:
      tags: [auth]
      summary: Terminate current session
      description: >
        Ends the active participant session and clears the authentication cookie.
      security:
        - sessionCookie: []
      responses:
        "204":
          description: Session terminated.
        "401":
          description: Unauthorized.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"

  /recommendation:
    get:
      tags: [recommendations]
      summary: List recommendation sessions
      description: >
        Returns a paginated list of all recommendation sessions created
        by the authenticated participant. Used for audit and analysis.
      security:
        - sessionCookie: []
      parameters:
        - in: query
          name: limit
          description: Page size.
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: offset
          description: Zero-based offset into result set.
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        "200":
          description: Paginated list of recommendation sessions.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Paginated"
                  - type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: "#/components/schemas/Recommendation"
        "401":
          description: Unauthorized.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"

    post:
      tags: [recommendations]
      summary: Create a recommendation session
      description: >
        Generates a recommendation list based on the user's preference profile.
        Records the full session for reproducibility and analysis.
      security:
        - sessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RecommendationRequest"
      responses:
        "201":
          description: Recommendation session created and stored.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Recommendation"
        "400":
          description: Invalid intent data.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"
        "401":
          description: Unauthorized.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"
        "503":
          description: Recommender temporarily unavailable.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"

  /recommendation/{session_id}:
    get:
      tags: [recommendations]
      summary: Get a recommendation session by ID
      description: >
        Retrieves the full recommendation session including request, model version,
        experiment condition, and detailed ranked results.
      security:
        - sessionCookie: []
      parameters:
        - in: path
          name: session_id
          required: true
          schema:
            type: string
            minLength: 1
      responses:
        "200":
          description: Recommendation session retrieved.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Recommendation"
        "401":
          description: Unauthorized.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"
        "404":
          description: Session not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"

  /games:
    get:
      tags: [games]
      summary: List boardgames
      description: >
        Returns boardgames from the canonical dataset with optional filters
        for genre, mechanics, themes, or free-text search.
      parameters:
        - in: query
          name: limit
          description: Page size.
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: offset
          description: Zero-based offset.
          schema:
            type: integer
            minimum: 0
            default: 0
        - in: query
          name: genre
          description: Filter by genre.
          style: form
          explode: true
          schema:
            type: array
            items:
              type: string
              minLength: 1
        - in: query
          name: mechanics
          description: Filter by mechanics.
          style: form
          explode: true
          schema:
            type: array
            items:
              type: string
              minLength: 1
        - in: query
          name: themes
          description: Filter by themes.
          style: form
          explode: true
          schema:
            type: array
            items:
              type: string
              minLength: 1
        - in: query
          name: q
          description: Text search filter for title or description.
          schema:
            type: string
            minLength: 1
      responses:
        "200":
          description: Paginated list of boardgames.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Paginated"
                  - type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: "#/components/schemas/BoardGame"
        "400":
          description: Invalid query parameters.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"

  /games/{id}:
    get:
      tags: [games]
      summary: Get a boardgame by ID
      description: >
        Provides the authoritative metadata for a boardgame. Used by study interfaces
        to retrieve details for explanations and reference-based reasoning.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            pattern: "^[0-9]+$"
      responses:
        "200":
          description: Boardgame retrieved.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BoardGame"
        "404":
          description: Boardgame not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"
